services:
  nats:
    image: nats:2.10
    command: ["-js"]
    volumes:
      - ../data/nats:/data
    ports:
      - "4222:4222"

  redis:
    image: redis:7
    volumes:
      - ../data/redis:/data
    ports:
      - "6379:6379"

  postgres:
    image: postgres:16
    env_file:
      - ./env/postgres.env
    volumes:
      - ../data/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  cloud-image:
    build:
      context: ..
      dockerfile: deploy/docker/cloud/Dockerfile
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/shared.env
      - ./env/cloud.env
    command: ["bash","-lc","echo cloud-image built"]
    restart: "no"

  cloud-bootstrap:
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/shared.env
      - ./env/cloud.env
    depends_on:
      cloud-image:
        condition: service_completed_successfully
      postgres:
        condition: service_started
      redis:
        condition: service_started
    command: >
      bash -lc "
        /deploy/scripts/init-postgres.sh &&
        /deploy/scripts/seed-redis.sh
      "
    restart: "no"

  cloud-api:
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/shared.env
      - ./env/cloud.env
    depends_on:
      cloud-bootstrap:
        condition: service_completed_successfully
      nats:
        condition: service_started
      redis:
        condition: service_started
      postgres:
        condition: service_started
    ports:
      - "8000:8000"
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port 8000


  mesh:
    build:
      context: ..
      dockerfile: deploy/docker/mesh/Dockerfile
    image: iot-wireless-mesh-daq/mesh:local
    env_file:
      - ./env/shared.env
      - ./env/mesh.env
    depends_on:
      nats:
        condition: service_started
      redis:
        condition: service_started
    command: python rundaq.py
    restart: unless-stopped

  daq-ui:
    build:
      context: ..
      dockerfile: deploy/docker/daq-ui/Dockerfile
    image: iot-wireless-mesh-daq/daq-ui:local
    env_file:
      - ./env/daq-ui.env
    ports:
      - "3000:3000"
    depends_on:
      cloud-api:
        condition: service_started
      bootstrap-health:
        condition: service_started
    restart: unless-stopped

  bootstrap-health:
    image: python:3.13-alpine
    depends_on:
      cloud-bootstrap:
        condition: service_completed_successfully
    ports:
      - "8001:8001"
    command: >
      sh -lc "python - <<'PY'
      from http.server import BaseHTTPRequestHandler, HTTPServer

      class H(BaseHTTPRequestHandler):
          def do_GET(self):
              if self.path in ('/health/bootstrap','/health','/'):
                  self.send_response(200)
                  self.end_headers()
                  self.wfile.write(b'OK\n')
              else:
                  self.send_response(404)
                  self.end_headers()

          def log_message(self, *a):
              pass

      HTTPServer(('0.0.0.0', 8001), H).serve_forever()
      PY"
    restart: unless-stopped

  mesh-emulator:
    image: iot-wireless-mesh-daq/mesh:local
    container_name: meshdaq-mesh-emulator-1
    restart: unless-stopped
    depends_on:
      - nats
    env_file:
      - ./env/shared.env
      - ./env/mesh.env

      # copy whatever mesh service already uses
      # (usually NATS urls / topics / site, etc.)
    command: ["python", "-u", "emulator.py"]
