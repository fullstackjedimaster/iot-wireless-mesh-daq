services:
  nats:
    image: nats:2.10
    command: ["-js", "-m", "8222"]
    env_file:
      - ./env/nats.env
    volumes:
      - ../data/nats:/data
    # internal-only: do NOT publish ports to host
    expose:
      - "4222"
      - "8222"
    networks:
      - internal_net

  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    env_file:
      - ./env/redis.env
    volumes:
      - ../data/redis:/data
    expose:
      - "6379"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep -q PONG"]
      interval: 3s
      timeout: 2s
      retries: 40
    networks:
      - internal_net

  postgres:
    image: postgres:16
    env_file:
      - ./env/postgres.env
    volumes:
      - ../data/postgres:/var/lib/postgresql/data
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ss -d ss -h localhost -p 5432"]
      interval: 3s
      timeout: 2s
      retries: 40
    networks:
      - internal_net

  cloud-image:
    build:
      context: ..
      dockerfile: deploy/docker/cloud/Dockerfile
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/cloud.env
    command: ["bash", "-lc", "echo cloud-image built"]
    restart: "no"
    networks:
      - internal_net

  cloud-bootstrap:
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/cloud.env
    depends_on:
      cloud-image:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["bash", "-lc", "/deploy/scripts/bootstrap.sh"]
    restart: "no"
    networks:
      - internal_net

  cloud-api:
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/cloud.env
    depends_on:
      cloud-bootstrap:
        condition: service_completed_successfully
      nats:
        condition: service_started
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    # reachable ONLY from droplet itself (nginx/portfolio) via loopback
    ports:
      - "127.0.0.1:8000:8000"
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
    restart: unless-stopped
    networks:
      - internal_net

  mesh:
    build:
      context: ..
      dockerfile: deploy/docker/mesh/Dockerfile
    image: iot-wireless-mesh-daq/mesh:local
    env_file:
      - ./env/mesh.env
    depends_on:
      nats:
        condition: service_started
      redis:
        condition: service_healthy
      cloud-api:
        condition: service_started
    command: ["python", "rundaq.py"]
    restart: unless-stopped
    networks:
      - internal_net

  bootstrap-health:
    image: python:3.13-alpine
    depends_on:
      cloud-bootstrap:
        condition: service_completed_successfully
    # reachable ONLY from droplet itself (nginx/portfolio) via loopback
    ports:
      - "127.0.0.1:8001:8001"
    command:
      - sh
      - -lc
      - |
        python - <<'PY'
        from http.server import BaseHTTPRequestHandler, HTTPServer
        class H(BaseHTTPRequestHandler):
            def do_GET(self):
                if self.path in ('/health/bootstrap', '/health', '/'):
                    self.send_response(200)
                    self.end_headers()
                    self.wfile.write(b'OK\n')
                else:
                    self.send_response(404)
                    self.end_headers()
            def log_message(self, *a):
                pass
        HTTPServer(('0.0.0.0', 8001), H).serve_forever()
        PY
    restart: unless-stopped
    networks:
      - internal_net

  daq-ui:
    build:
      context: ..
      dockerfile: deploy/docker/daq-ui/Dockerfile
    image: iot-wireless-mesh-daq/daq-ui:local
    env_file:
      - ./env/daq-ui.env
    # reachable ONLY from droplet itself (nginx/portfolio) via loopback
    ports:
      - "127.0.0.1:3000:3000"
    depends_on:
      cloud-api:
        condition: service_started
      bootstrap-health:
        condition: service_started
    restart: unless-stopped
    networks:
      - internal_net

networks:
  internal_net:
    driver: bridge
    internal: true
