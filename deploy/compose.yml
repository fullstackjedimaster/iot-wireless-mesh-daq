services:
  nats:
    image: nats:2.10
    command: ["-js", "-sd", "/data"]
    volumes:
      - ../data/nats:/data
    ports:
      - "127.0.0.1:4222:4222"
    restart: unless-stopped
    # nats image runs non-root by default
    security_opt:
      - no-new-privileges:true

  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ../data/redis:/data
    ports:
      - "127.0.0.1:6379:6379"
    restart: unless-stopped
    # redis image runs as redis user in official image
    security_opt:
      - no-new-privileges:true

  postgres:
    image: postgres:16
    env_file:
      - ./env/postgres.env
    volumes:
      - ../data/postgres:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    restart: unless-stopped
    # postgres image runs as postgres user in official image
    security_opt:
      - no-new-privileges:true

  # Build-only helper (kept for your existing flow)
  cloud-image:
    build:
      context: ..
      dockerfile: deploy/docker/cloud/Dockerfile
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/shared.env
      - ./env/cloud.env
    command: ["sh","-lc","echo cloud-image built"]
    restart: "no"

  cloud-bootstrap:
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/shared.env
      - ./env/cloud.env
    depends_on:
      cloud-image:
        condition: service_completed_successfully
      postgres:
        condition: service_started
      redis:
        condition: service_started
    command: >
      sh -lc "
        /deploy/scripts/init-postgres.sh &&
        /deploy/scripts/seed-redis.sh
      "
    restart: "no"
    pids_limit: 128
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m

  cloud-api:
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/shared.env
      - ./env/cloud.env
    depends_on:
      cloud-bootstrap:
        condition: service_completed_successfully
      nats:
        condition: service_started
      redis:
        condition: service_started
      postgres:
        condition: service_started
    ports:
      - "127.0.0.1:8000:8000"
    command: >
      uvicorn apps.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m

  mesh:
    build:
      context: ..
      dockerfile: deploy/docker/mesh/Dockerfile
    image: iot-wireless-mesh-daq/mesh:local
    env_file:
      - ./env/shared.env
      - ./env/mesh.env
    depends_on:
      nats:
        condition: service_started
      redis:
        condition: service_started
    command: ["python","-u","rundaq.py"]
    restart: unless-stopped
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m

  # IMPORTANT: host port should be 3001 per your canonical port plan
  daq-ui:
    build:
      context: ..
      dockerfile: deploy/docker/daq-ui/Dockerfile
    image: iot-wireless-mesh-daq/daq-ui:local
    env_file:
      - ./env/daq-ui.env
    ports:
      - "127.0.0.1:3001:3000"
    depends_on:
      cloud-api:
        condition: service_started
      bootstrap-health:
        condition: service_started
    restart: unless-stopped
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m

  bootstrap-health:
    image: python:3.13-alpine
    depends_on:
      cloud-bootstrap:
        condition: service_completed_successfully
    # only needed for internal depends_on; keep it localhost if you want to curl it
    ports:
      - "127.0.0.1:8001:8001"
    user: "1001:1001"
    command: >
      sh -lc "python - <<'PY'
      from http.server import BaseHTTPRequestHandler, HTTPServer

      class H(BaseHTTPRequestHandler):
          def do_GET(self):
              if self.path in ('/health/bootstrap','/health','/'):
                  self.send_response(200)
                  self.end_headers()
                  self.wfile.write(b'OK\n')
              else:
                  self.send_response(404)
                  self.end_headers()

          def log_message(self, *a):
              pass

      HTTPServer(('0.0.0.0', 8001), H).serve_forever()
      PY"
    restart: unless-stopped
    pids_limit: 64
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=32m

  mesh-emulator:
    image: iot-wireless-mesh-daq/mesh:local
    container_name: meshdaq-mesh-emulator-1
    restart: unless-stopped
    depends_on:
      - nats
    env_file:
      - ./env/shared.env
      - ./env/mesh.env
    command: ["python", "-u", "emulator.py"]
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m
