name: iot-wireless-mesh-daq

services:
  nats:
    image: nats:2.10
    command: ["-js", "-sd", "/data"]
    volumes:
      - ../data/nats:/data
    ports:
      - "127.0.0.1:4222:4222"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ../data/redis:/data
    # NOTE: no host port mapping -> avoids collisions
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "redis-cli", "PING"]
      interval: 2s
      timeout: 2s
      retries: 60

  postgres:
    image: postgres:16
    env_file:
      - ./env/postgres.env
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"

    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \"$${POSTGRES_USER}\" -d \"$${POSTGRES_DB}\""]
      interval: 2s
      timeout: 3s
      retries: 60

  # One-shot init job: creates schema/data in Postgres and seeds Redis
  cloud-bootstrap:
    build:
      context: .
      dockerfile: docker/bootstrap/Dockerfile
    image: iot-wireless-mesh-daq/bootstrap:local
    env_file:
      - ./env/postgres.env
      - ./env/cloud.env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -lc "
        set -eux;
        /deploy/scripts/init-postgres.sh;
        /deploy/scripts/seed-redis.sh
      "
    restart: "no"

  cloud:
    image: iot-wireless-mesh-daq/cloud:local
    command: ["python", "-u", "run_catcher.py"]
    env_file:
      - ./env/cloud.env
    depends_on:
      nats:
        condition: service_started
      redis:
        condition: service_healthy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

  # Cloud API
  cloud-api:
    build:
      context: .
      dockerfile: docker/cloud/Dockerfile
      additional_contexts:
        repo: ..
    image: iot-wireless-mesh-daq/cloud:local
    env_file:
      - ./env/cloud.env
    depends_on:
      cloud-bootstrap:
        condition: service_completed_successfully
      nats:
        condition: service_started
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports:
      - "127.0.0.1:8000:8000"
    command: uvicorn apps.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m

  # Mesh server
  mesh:
    build:
      context: .
      dockerfile: docker/mesh/Dockerfile
      additional_contexts:
        repo: ..
    image: iot-wireless-mesh-daq/mesh:local
    env_file:
      - ./env/mesh.env
    depends_on:
      nats:
        condition: service_started
      redis:
        condition: service_healthy
      cloud-api:
        condition: service_started
    command: ["sh", "-lc", "python -u rundaq.py"]
    restart: unless-stopped
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m

  daq-ui:
    build:
      context: .
      dockerfile: docker/daq-ui/Dockerfile
      additional_contexts:
        repo: ..
    image: iot-wireless-mesh-daq/daq-ui:local
    env_file:
      - ./env/daq-ui.env
    ports:
      - "127.0.0.1:3001:3000"
    depends_on:
      cloud-api:
        condition: service_started
      bootstrap-health:
        condition: service_started
    restart: unless-stopped
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m

  # Health beacon for “bootstrap finished”
  bootstrap-health:
    image: iot-wireless-mesh-daq/bootstrap:local
    depends_on:
      cloud-bootstrap:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:8011:8011"
    user: "1001:1001"
    command:
      - sh
      - -lc
      - |
        python -c '
        from http.server import BaseHTTPRequestHandler, HTTPServer

        class H(BaseHTTPRequestHandler):
            def do_GET(self):
                if self.path in ("/health/bootstrap", "/health", "/"):
                    self.send_response(200)
                    self.end_headers()
                    self.wfile.write(b"OK\n")
                else:
                    self.send_response(404)
                    self.end_headers()
            def log_message(self, *a):
                pass

        HTTPServer(("0.0.0.0", 8011), H).serve_forever()
        '
    restart: unless-stopped
    pids_limit: 64
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=32m

  mesh-emulator:
    image: iot-wireless-mesh-daq/mesh:local
    env_file:
      - ./env/mesh.env
    depends_on:
      nats:
        condition: service_started
      redis:
        condition: service_healthy
      cloud-api:
        condition: service_started
    command: ["sh", "-lc", "python -u emulator.py"]
    restart: unless-stopped
    pids_limit: 256
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m

volumes:
  pgdata: {}
